<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\Entity\Node;
use Drupal\node\NodeInterface;


/**
 * Implements hook_jsonld_alter_normalized_array().
 *
 * Alter the normalized array based on the value of a configured field
 *
 */

function jsonld_markup_jsonld_alter_normalized_array(EntityInterface $entity, array &$normalized, array $context) {
  $config = \Drupal::state()->get(\Drupal\jsonld_markup\Form\JsonLDMarkupSettingsForm::JSONLD_MARKUP_SETTINGS_PAGE);
  $field = ($config['schema_field']) ?: '';


  if(($node = \Drupal::routeMatch()->getParameter('node'))){
    if ($node instanceof \Drupal\node\NodeInterface) {
      $nid = $node->id();
      $node = \Drupal\node\Entity\Node::load($nid);
      if($node->hasField($field)){
        $my_field_data = $node->get($field)->getValue();
        $my_field_value= $my_field_data [0]['value'];
      }
    }
  }
  if(isset($my_field_data)){
    $normalized['@graph']['0']['@type'] = ["http://schema.org/" . $my_field_value];
  }


}


/**
 * Implements hook_page_attachments_alter().
 *
 * Inject the JSON-LD into the HTML
 *
 */
function jsonld_markup_page_attachments_alter(array &$attachments) {

  $currentURL = $_SERVER['REQUEST_SCHEME'] . '://' . $_SERVER['HTTP_HOST'] . strtok($_SERVER['REQUEST_URI'], '?') . '?_format=jsonld';

  try {
    $response = \Drupal::httpClient()->request('GET', $currentURL);
    $jsonld= $response->getBody()->getContents();
  
  } catch (\Exception $e) {
    $jsonld = $e->getMessage();
  }

  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'script',
      '#value' => $jsonld,
      '#attributes' => ['type' => 'application/ld+json'],
    ],
  ];
}
